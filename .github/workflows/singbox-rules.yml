name: Build sing-box ruleâ€‘set

on:
  schedule:
    - cron: '0 3 * * *'   # æ¯å¤© 03:00 UTC è‡ªåŠ¨æ‰§è¡Œ
  push:
    branches: [ main ]    # æ‰‹åŠ¨æ¨é€ main åˆ†æ”¯æ—¶ä¹Ÿä¼šè§¦å‘
  workflow_dispatch: {}    # å…è®¸åœ¨ UI æ‰‹åŠ¨è§¦å‘

jobs:
  build-rule-set:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # éœ€è¦å†™æƒé™æ‰èƒ½ push

    steps:
      # 1ï¸âƒ£ Checkout æœ¬ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å®Œæ•´å†å²ï¼Œåé¢éœ€è¦ git commit

      # 2ï¸âƒ£ Checkout v2fly/domain-list-communityï¼ˆåªéœ€è¦ dataï¼‰
      - name: Checkout domainâ€‘listâ€‘community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: domain-list-community
          ref: refs/tags/latest   # ä½¿ç”¨æœ€æ–° Releaseï¼ˆGitHub ä¼šè‡ªåŠ¨æŒ‡å‘æœ€æ–° tagï¼‰

      # 3ï¸âƒ£ ä¸‹è½½å®˜æ–¹ geoip.datï¼ˆå› ä¸º domainâ€‘listâ€‘community ä¸æä¾›ï¼‰
      - name: Download geoip.dat
        run: |
          curl -L -o geoip.dat \
            https://github.com/v2fly/geoip/releases/latest/download/geoip.dat

      # 4ï¸âƒ£ ä¸‹è½½å¹¶å‡†å¤‡ geosite.datï¼ˆå®é™…ä¸º dlc.datï¼‰
      - name: Prepare geosite.dat
        run: |
          cp domain-list-community/dlc.dat geosite.dat

      # 5ï¸âƒ£ Checkout metaâ€‘rulesâ€‘converter
      - name: Checkout metaâ€‘rulesâ€‘converter
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-converter
          path: meta-rules-converter

      # 6ï¸âƒ£ Setup Go ç¯å¢ƒå¹¶ç¼–è¯‘ converter
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'   # å…¼å®¹æœ€æ–° Go ç‰ˆæœ¬

      - name: Build converter
        working-directory: meta-rules-converter
        run: |
          go build -o converter ./cmd/converter

      # 7ï¸âƒ£ æ‰§è¡Œè½¬æ¢ï¼ˆç”Ÿæˆ singâ€‘box ruleâ€‘setï¼‰
      - name: Convert to singâ€‘box ruleâ€‘set
        env:
          CONVERTER: ${{ github.workspace }}/meta-rules-converter/converter
        run: |
          mkdir -p sing-rule/geo/geosite
          mkdir -p sing-rule/geo/geoip
          $CONVERTER geosite -f ${{ github.workspace }}/geosite.dat \
            -o ${{ github.workspace }}/sing-rule/geo/geosite -t sing-box
          $CONVERTER geoip -f ${{ github.workspace }}/geoip.dat \
            -o ${{ github.workspace }}/sing-rule/geo/geoip -t sing-box
          # å¦‚éœ€ asnï¼Œå¯è‡ªè¡Œä¸‹è½½ GeoLite2â€‘ASN.mmdb å¹¶æ‰§è¡Œï¼š
          # $CONVERTER asn -f GeoLite2-ASN.mmdb -o sing-rule/asn -t sing-box

      # 8ï¸âƒ£ Commit & push ç”Ÿæˆçš„ ruleâ€‘set
      - name: Commit generated ruleâ€‘set
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add sing-rule/
          if git diff --cached --quiet; then
            echo "No changes, skip commit."
          else
            git commit -m "ğŸ¤– Update sing-box ruleâ€‘set (auto)"
            git push
          fi

      # 9ï¸âƒ£ï¼ˆå¯é€‰ï¼‰åˆ›å»º Release å¹¶ä¸Šä¼ èµ„äº§
      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "sing-rule-$(date +%Y%m%d%H%M)"
          name: "singâ€‘box ruleâ€‘set $(date +%Y-%m-%d %H:%M)"
          body: "è‡ªåŠ¨ç”Ÿæˆçš„ singâ€‘box geosite / geoip ruleâ€‘setï¼Œæ¥æºäº v2fly/domainâ€‘listâ€‘community ä¸å®˜æ–¹ geoipã€‚"
          files: |
            sing-rule/geo/geosite/*
            sing-rule/geo/geoip/*
